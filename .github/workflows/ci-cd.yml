on:
  push:
    branches:
      - main

env:
  IMAGE_NAME: flask-devops-app

jobs:
  build-scan-push-deploy:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout Code
      uses: actions/checkout@v4

    # ğŸ” Login to DockerHub
    - name: Docker Login
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # ğŸ³ Build Docker Image
    - name: Build Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }} ./app

    # ğŸ” Trivy Scan
    - name: Run Trivy Vulnerability Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
        severity: HIGH,CRITICAL
        exit-code: 1

    # ğŸš€ Push Image
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}

    # â˜¸ Deploy to Kubernetes
    - name: Setup Kubectl
      uses: azure/setup-kubectl@v4

    - name: Deploy using Helm
      run: |
        helm upgrade --install flask-app ./helm/flask-app \
        --set image.repository=${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }} \
        --set image.tag=${{ github.run_number }}
